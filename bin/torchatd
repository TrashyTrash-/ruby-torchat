#! /usr/bin/env ruby
require 'optparse'
require 'torchat'

options = {}

OptionParser.new do |o|
	options[:config] = File.expand_path '~/.torchat/torchat.yml'

	o.on '-c', '--config PATH', 'the path to the config file' do |path|
		options[:config] = path
	end
end.parse!

%w[INT KILL].each {|sig|
	trap sig do
		puts 'torchatd stopping, bye'

		EM.stop_event_loop
	end
}


EM.run {
	Torchat.new(options[:config]).start {|s|
		s.on :incoming do |incoming|
			puts "incoming connection from #{incoming}"
		end

		s.on :outgoing do |outgoing|
			puts "outgoing connection to #{outgoing}"
		end

		s.on :connection do |buddy|
			puts "#{buddy.id} connected"
		end

		s.on :verification do |buddy|
			puts "#{buddy.id} has been verified"
		end

		s.on :disconnection do |buddy|
			puts "#{buddy.id} disconnected"
		end

		s.on :message do |message|

		end
	}

	puts 'torchatd started'
}
